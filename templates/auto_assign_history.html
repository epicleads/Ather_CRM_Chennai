{% extends "base.html" %}

{% block title %}Auto-Assign History - Ather CRM{% endblock %}

{% block content %}
<style>
    :root {
        --bg-light: #F7F9FA;
        --surface: #FFFFFF;
        --text-primary: #333333;
        --text-secondary: #6B7280;
        --accent-green: #3DC55E;
        --accent-dark: #276749;
        --border: #E5E7EB;
    }
    
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: var(--bg-light);
        margin: 0;
        padding: 24px;
        min-height: 100vh;
        color: var(--text-primary);
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--surface);
        border-radius: 18px;
        padding: 32px 36px;
        box-shadow: 0 4px 32px rgba(60,72,88,0.08);
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 2px solid var(--border);
    }
    
    .header-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .page-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }
    
    .timezone-info {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: var(--text-secondary);
        background: var(--bg-light);
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid var(--border);
    }
    
    .back-button {
        background: var(--accent-dark);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .back-button:hover {
        background: var(--accent-green);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(61,197,94,0.3);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }
    
    .stat-card {
        background: var(--bg-light);
        border: 1.5px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        border-color: var(--accent-green);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(61,197,94,0.15);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-green);
        margin-bottom: 8px;
    }
    
    .stat-label {
        font-size: 1rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .history-table-container {
        background: var(--surface);
        border: 1.5px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    }
    
    .table-header {
        background: var(--bg-light);
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .table-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .table-controls {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    
    .search-box {
        flex: 1;
        min-width: 300px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 12px 16px 12px 48px;
        border: 1.5px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--accent-green);
        box-shadow: 0 0 0 3px rgba(61,197,94,0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
    }
    
    .filter-dropdown {
        padding: 12px 16px;
        border: 1.5px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-dropdown:focus {
        outline: none;
        border-color: var(--accent-green);
    }
    
    .export-btn {
        background: var(--accent-green);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .export-btn:hover {
        background: var(--accent-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(61,197,94,0.3);
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .history-table th {
        background: var(--bg-light);
        padding: 16px 20px;
        text-align: left;
        font-weight: 700;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .history-table td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    
    .history-table tr:hover {
        background: var(--bg-light);
    }
    
    .lead-uid {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--accent-dark);
        background: rgba(61,197,94,0.1);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85rem;
    }
    
    .cre-name {
        font-weight: 600;
        color: var(--accent-green);
    }
    
    .source-tag {
        background: var(--bg-light);
        color: var(--text-secondary);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid var(--border);
    }
    
    .assignment-method {
        background: rgba(61,197,94,0.1);
        color: var(--accent-dark);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .count-change {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--text-secondary);
    }
    
    .timestamp {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    
    .no-data i {
        font-size: 3rem;
        margin-bottom: 16px;
        color: var(--border);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border);
    }
    
    .page-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .page-btn:hover {
        border-color: var(--accent-green);
        color: var(--accent-green);
    }
    
    .page-btn.active {
        background: var(--accent-green);
        color: white;
        border-color: var(--accent-green);
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
        .container {
            padding: 20px;
            margin: 16px;
        }
        
        .page-header {
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table-controls {
            flex-direction: column;
        }
        
        .search-box {
            min-width: auto;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px 16px;
            font-size: 0.85rem;
        }
    }
</style>

<div class="container">
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">
                <i class="fas fa-history"></i>
                Auto-Assign History
            </h1>
            <div class="timezone-info">
                <i class="fas fa-clock" style="color: var(--accent-green); margin-right: 8px;"></i>
                <span>Timestamps displayed in IST (UTC+5:30)</span>
            </div>
        </div>
        <a href="{{ url_for('assign_leads') }}" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Lead Assignment
        </a>
    </div>
    
    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ history|length }}</div>
            <div class="stat-label">Total Assignments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ history|selectattr('assignment_method', 'equalto', 'fair_distribution')|list|length }}</div>
            <div class="stat-label">Fair Distribution</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ history|selectattr('source')|map(attribute='source')|unique|list|length }}</div>
            <div class="stat-label">Active Sources</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ history|selectattr('assigned_cre_name')|map(attribute='assigned_cre_name')|unique|list|length }}</div>
            <div class="stat-label">CREs Involved</div>
        </div>
    </div>
    
    <!-- History Table -->
    <div class="history-table-container">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-table"></i>
                Assignment History
            </h3>
            <div class="table-controls">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by lead UID, CRE name, or source...">
                </div>
                <select class="filter-dropdown" id="sourceFilter">
                    <option value="">All Sources</option>
                    {% for source in history|selectattr('source')|map(attribute='source')|unique|list %}
                    <option value="{{ source }}">{{ source }}</option>
                    {% endfor %}
                </select>
                <select class="filter-dropdown" id="methodFilter">
                    <option value="">All Methods</option>
                    <option value="fair_distribution">Fair Distribution</option>
                </select>
                <button class="export-btn" onclick="exportHistory()">
                    <i class="fas fa-download"></i>
                    Export CSV
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            {% if history %}
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>Lead UID</th>
                        <th>Source</th>
                        <th>Assigned CRE</th>
                        <th>Lead Count Change</th>
                        <th>Assignment Method</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in history %}
                    <tr class="history-row" 
                        data-uid="{{ record.lead_uid }}" 
                        data-source="{{ record.source }}" 
                        data-cre="{{ record.assigned_cre_name }}"
                        data-method="{{ record.assignment_method }}">
                        <td>
                            <span class="lead-uid">{{ record.lead_uid }}</span>
                        </td>
                        <td>
                            <span class="source-tag">{{ record.source }}</span>
                        </td>
                        <td>
                            <span class="cre-name">{{ record.assigned_cre_name }}</span>
                        </td>
                        <td>
                            <span class="count-change">
                                {{ record.cre_total_leads_before }} → {{ record.cre_total_leads_after }}
                            </span>
                        </td>
                        <td>
                            <span class="assignment-method">{{ record.assignment_method }}</span>
                        </td>
                        <td>
                            <span class="timestamp" data-utc="{{ record.created_at }}">
                                {% if record.created_at %}
                                    <span class="date-part">{{ record.created_at.split('T')[0] if 'T' in record.created_at else record.created_at.split(' ')[0] }}</span>
                                    <br>
                                    <small class="time-part">{{ record.created_at.split('T')[1][:8] if 'T' in record.created_at else record.created_at.split(' ')[1] if ' ' in record.created_at else '' }}</small>
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-data">
                <i class="fas fa-inbox"></i>
                <h3>No Auto-Assign History Found</h3>
                <p>No automatic lead assignments have been recorded yet.</p>
                <p>Start configuring auto-assign rules to see history here.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Pagination -->
    {% if history|length > 20 %}
    <div class="pagination">
        <button class="page-btn" id="prevPage" onclick="changePage(-1)">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span id="pageInfo">Page 1 of {{ (history|length / 20)|round(0, 'ceil')|int }}</span>
        <button class="page-btn" id="nextPage" onclick="changePage(1)">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    {% endif %}
</div>

<script>
let currentPage = 1;
const rowsPerPage = 20;
let filteredRows = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeTable();
    setupEventListeners();
    convertTimestampsToIST();
});

// Convert UTC timestamps to IST (UTC+5:30)
function convertTimestampsToIST() {
    const timestampElements = document.querySelectorAll('.timestamp[data-utc]');
    
    timestampElements.forEach(element => {
        const utcTimestamp = element.getAttribute('data-utc');
        if (!utcTimestamp || utcTimestamp === 'N/A') return;
        
        try {
            // Parse UTC timestamp
            let utcTime;
            if (utcTimestamp.includes('T')) {
                // ISO format: 2025-08-16T18:03:40.847441+00:00
                utcTime = new Date(utcTimestamp);
            } else {
                // Other format: try to parse
                utcTime = new Date(utcTimestamp);
            }
            
            if (isNaN(utcTime.getTime())) return;
            
            // Convert to IST (UTC+5:30)
            const istTime = new Date(utcTime.getTime() + (5.5 * 60 * 60 * 1000));
            
            // Format IST time
            const datePart = istTime.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const timePart = istTime.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            // Update the display
            const dateSpan = element.querySelector('.date-part');
            const timeSpan = element.querySelector('.time-part');
            
            if (dateSpan) dateSpan.textContent = datePart;
            if (timeSpan) timeSpan.textContent = timePart;
            
            // Add tooltip showing original UTC time
            element.title = `UTC: ${utcTimestamp}\nIST: ${datePart} ${timePart}`;
            
        } catch (error) {
            console.error('Error converting timestamp:', error);
        }
    });
}

function initializeTable() {
    const rows = document.querySelectorAll('.history-row');
    filteredRows = Array.from(rows);
    showPage(1);
}

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterTable();
    });
    
    // Source filter
    document.getElementById('sourceFilter').addEventListener('change', function(e) {
        filterTable();
    });
    
    // Method filter
    document.getElementById('methodFilter').addEventListener('change', function(e) {
        filterTable();
    });
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceFilter').value;
    const methodFilter = document.getElementById('methodFilter').value;
    
    const rows = document.querySelectorAll('.history-row');
    filteredRows = Array.from(rows).filter(row => {
        const uid = row.dataset.uid.toLowerCase();
        const source = row.dataset.source.toLowerCase();
        const cre = row.dataset.cre.toLowerCase();
        const method = row.dataset.method.toLowerCase();
        
        // Search filter
        const matchesSearch = !searchTerm || 
            uid.includes(searchTerm) || 
            source.includes(searchTerm) || 
            cre.includes(searchTerm);
        
        // Source filter
        const matchesSource = !sourceFilter || source === sourceFilter.toLowerCase();
        
        // Method filter
        const matchesMethod = !methodFilter || method === methodFilter.toLowerCase();
        
        return matchesSearch && matchesSource && matchesMethod;
    });
    
    currentPage = 1;
    showPage(1);
    updatePagination();
    
    // Reconvert timestamps after filtering
    convertTimestampsToIST();
}

function showPage(page) {
    const startIndex = (page - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    
    // Hide all rows
    document.querySelectorAll('.history-row').forEach(row => {
        row.style.display = 'none';
    });
    
    // Show rows for current page
    filteredRows.slice(startIndex, endIndex).forEach(row => {
        row.style.display = '';
    });
    
    updatePagination();
    
    // Reconvert timestamps for visible rows
    convertTimestampsToIST();
}

function changePage(delta) {
    const newPage = currentPage + delta;
    const maxPage = Math.ceil(filteredRows.length / rowsPerPage);
    
    if (newPage >= 1 && newPage <= maxPage) {
        currentPage = newPage;
        showPage(currentPage);
    }
}

function updatePagination() {
    const maxPage = Math.ceil(filteredRows.length / rowsPerPage);
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (pageInfo) {
        pageInfo.textContent = `Page ${currentPage} of ${maxPage}`;
    }
    
    if (prevBtn) {
        prevBtn.disabled = currentPage <= 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentPage >= maxPage;
    }
}

function exportHistory() {
    try {
        // Get visible rows (current page)
        const visibleRows = filteredRows.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
        
        if (visibleRows.length === 0) {
            alert('No data to export');
            return;
        }
        
        // Prepare CSV data
        const csvData = [
            ['Lead UID', 'Source', 'Assigned CRE', 'Lead Count Before', 'Lead Count After', 'Assignment Method', 'Timestamp']
        ];
        
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [
                cells[0].textContent.trim(),
                cells[1].textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim().split('→')[0].trim(),
                cells[3].textContent.trim().split('→')[1].trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim()
            ];
            csvData.push(rowData);
        });
        
        // Convert to CSV string
        const csvString = csvData.map(row => 
            row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        // Create and download file
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `auto_assign_history_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        showAlert('✅ History exported successfully!', 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showAlert('❌ Error exporting history', 'error');
    }
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-refresh every 30 seconds
setInterval(() => {
    // Only refresh if user is not actively interacting
    if (!document.hasFocus()) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}
