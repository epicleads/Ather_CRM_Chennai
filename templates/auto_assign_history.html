{% extends "base.html" %}

{% block title %}Auto-Assign History - Ather CRM{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Auto-Assign History
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Filters Section -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="sourceFilter" class="form-label">Source Filter</label>
                            <select class="form-select" id="sourceFilter">
                                <option value="">All Sources</option>
                                <option value="Google">Google</option>
                                <option value="Meta">Meta</option>
                                <option value="Affiliate">Affiliate</option>
                                <option value="Know">Know</option>
                                <option value="Whatsapp">Whatsapp</option>
                                <option value="Tele">Tele</option>
                                <option value="Activity">Activity</option>
                                <option value="Walk-in">Walk-in</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="creFilter" class="form-label">CRE Filter</label>
                            <select class="form-select" id="creFilter">
                                <option value="">All CREs</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="fromDate" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="fromDate">
                        </div>
                        <div class="col-md-2">
                            <label for="toDate" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="toDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="applyFilters()">
                                <i class="fas fa-filter me-1"></i> Apply
                            </button>
                            <button class="btn btn-success" onclick="exportToCSV()">
                                <i class="fas fa-download me-1"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Assignments</h5>
                                    <h3 id="totalAssignments">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Today's Assignments</h5>
                                    <h3 id="todayAssignments">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">This Week</h5>
                                    <h3 id="weekAssignments">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">This Month</h5>
                                    <h3 id="monthAssignments">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="historyTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Lead UID</th>
                                    <th>Source</th>
                                    <th>Assigned CRE</th>
                                    <th>CRE Username</th>
                                    <th>Leads Before</th>
                                    <th>Leads After</th>
                                    <th>Method</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Auto-assign history pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be populated here -->
                        </ul>
                    </nav>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading auto-assign history...</p>
                    </div>

                    <!-- No Data Message -->
                    <div id="noDataMessage" class="text-center" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No auto-assign history found for the selected filters.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CRE Selection Modal for Adding to Source Bucket -->
<div class="modal fade" id="addCreModal" tabindex="-1" aria-labelledby="addCreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCreModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    Add CRE to Source Bucket
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Source: <strong id="modalSourceName"></strong></label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select CREs to add:</label>
                    <div id="creSelectionList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- CRE checkboxes will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedCres()">
                    <i class="fas fa-plus me-1"></i> Add Selected CREs
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};
let availableCres = [];
let currentSourceForModal = '';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadAutoAssignHistory();
    loadAvailableCres();
    setDefaultDates();
});

function setDefaultDates() {
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(lastMonth.getMonth() - 1);
    
    document.getElementById('fromDate').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('toDate').value = today.toISOString().split('T')[0];
}

function loadAvailableCres() {
    fetch('/get_auto_assign_configs')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.available_cres) {
                availableCres = data.available_cres;
                populateCreFilter();
            }
        })
        .catch(error => {
            console.error('Error loading CREs:', error);
        });
}

function populateCreFilter() {
    const creFilter = document.getElementById('creFilter');
    creFilter.innerHTML = '<option value="">All CREs</option>';
    
    availableCres.forEach(cre => {
        const option = document.createElement('option');
        option.value = cre.id;
        option.textContent = `${cre.name} (${cre.username})`;
        creFilter.appendChild(option);
    });
}

function applyFilters() {
    currentPage = 1;
    currentFilters = {
        source: document.getElementById('sourceFilter').value,
        cre_id: document.getElementById('creFilter').value,
        from_date: document.getElementById('fromDate').value,
        to_date: document.getElementById('toDate').value
    };
    loadAutoAssignHistory();
}

function loadAutoAssignHistory() {
    const spinner = document.getElementById('loadingSpinner');
    const tableBody = document.getElementById('historyTableBody');
    const noDataMessage = document.getElementById('noDataMessage');
    
    spinner.style.display = 'block';
    tableBody.innerHTML = '';
    noDataMessage.style.display = 'none';
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: 50,
        ...currentFilters
    });
    
    fetch(`/get_auto_assign_history?${params}`)
        .then(response => response.json())
        .then(data => {
            spinner.style.display = 'none';
            
            if (data.success && data.data.length > 0) {
                displayHistoryData(data.data);
                updatePagination(data.pagination);
                updateStatistics(data.data);
            } else {
                noDataMessage.style.display = 'block';
                updateStatistics([]);
            }
        })
        .catch(error => {
            spinner.style.display = 'none';
            console.error('Error loading history:', error);
            noDataMessage.style.display = 'block';
        });
}

function displayHistoryData(data) {
    const tableBody = document.getElementById('historyTableBody');
    tableBody.innerHTML = '';
    
    data.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.lead_uid}</td>
            <td><span class="badge bg-primary">${record.source}</span></td>
            <td>${record.assigned_cre_name}</td>
            <td>${record.cre_username}</td>
            <td>${record.cre_total_leads_before}</td>
            <td>${record.cre_total_leads_after}</td>
            <td><span class="badge bg-success">${record.assignment_method}</span></td>
            <td>${record.created_at_formatted}</td>
        `;
        tableBody.appendChild(row);
    });
}

function updatePagination(pagination) {
    const paginationElement = document.getElementById('pagination');
    paginationElement.innerHTML = '';
    
    totalPages = pagination.total_pages;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    paginationElement.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationElement.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    paginationElement.appendChild(nextLi);
}

function changePage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        loadAutoAssignHistory();
    }
}

function updateStatistics(data) {
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    const monthAgo = new Date();
    monthAgo.setMonth(monthAgo.getMonth() - 1);
    const monthAgoStr = monthAgo.toISOString().split('T')[0];
    
    let todayCount = 0;
    let weekCount = 0;
    let monthCount = 0;
    
    data.forEach(record => {
        const recordDate = record.created_at.split('T')[0];
        if (recordDate === today) todayCount++;
        if (recordDate >= weekAgoStr) weekCount++;
        if (recordDate >= monthAgoStr) monthCount++;
    });
    
    document.getElementById('totalAssignments').textContent = data.length;
    document.getElementById('todayAssignments').textContent = todayCount;
    document.getElementById('weekAssignments').textContent = weekCount;
    document.getElementById('monthAssignments').textContent = monthCount;
}

function exportToCSV() {
    const params = new URLSearchParams({
        ...currentFilters
    });
    
    const link = document.createElement('a');
    link.href = `/export_auto_assign_history_csv?${params}`;
    link.download = `auto_assign_history_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// CRE Management Functions
function openAddCreModal(source) {
    currentSourceForModal = source;
    document.getElementById('modalSourceName').textContent = source;
    
    // Populate CRE selection list
    const creList = document.getElementById('creSelectionList');
    creList.innerHTML = '';
    
    availableCres.forEach(cre => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${cre.id}" id="cre_${cre.id}">
            <label class="form-check-label" for="cre_${cre.id}">
                ${cre.name} (${cre.username})
            </label>
        `;
        creList.appendChild(div);
    });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addCreModal'));
    modal.show();
}

function addSelectedCres() {
    const selectedCres = [];
    const checkboxes = document.querySelectorAll('#creSelectionList input[type="checkbox"]:checked');
    
    checkboxes.forEach(checkbox => {
        selectedCres.push(parseInt(checkbox.value));
    });
    
    if (selectedCres.length === 0) {
        alert('Please select at least one CRE to add.');
        return;
    }
    
    // Save configuration
    saveAutoAssignConfig(currentSourceForModal, selectedCres);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addCreModal'));
    modal.hide();
}

function saveAutoAssignConfig(source, creIds) {
    fetch('/save_auto_assign_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            source: source,
            cre_ids: creIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const cardBody = document.querySelector('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
            
            // Refresh the page to show updated configuration
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving config:', error);
        alert('Error saving configuration. Please try again.');
    });
}
</script>
{% endblock %}
