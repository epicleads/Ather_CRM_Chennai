{% extends "base.html" %}

{% block title %}CRE Analytics - Ather CRM{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .analytics-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 20px;
        font-weight: 600;
        text-align: center;
    }
    
    .table td {
        padding: 15px 20px;
        vertical-align: middle;
        border-color: #e9ecef;
        text-align: center;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,123,255,0.05);
    }
    
    .current-cre-highlight {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .leaderboard-rank-1 {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
        font-weight: bold;
    }
    
    .current-user-row {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        color: white !important;
        font-weight: bold;
    }
    
    .current-user-row td {
        color: white !important;
    }
    
    .conversion-rate-high {
        color: #28a745;
        font-weight: bold;
    }
    
    .conversion-rate-medium {
        color: #ffc107;
        font-weight: bold;
    }
    
    .conversion-rate-low {
        color: #dc3545;
        font-weight: bold;
    }
    
    .trophy-icon {
        font-size: 1.2em;
        color: #ffd700;
        margin-right: 5px;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line text-primary"></i> CRE Analytics Dashboard</h2>
                <p class="text-muted">Performance insights and metrics for {{ analytics.current_cre }}</p>
            </div>
            <div>
                <a href="{{ url_for('cre_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Current CRE Highlight -->
<div class="current-cre-highlight">
    <h5 class="mb-0"><i class="fas fa-user-circle"></i> Analytics for: {{ analytics.current_cre }}</h5>
</div>

<!-- Zoho Dashboards Section -->
<div class="mb-4">
    <h5 style="color: var(--airbnb-red); font-weight: 600; margin-bottom: 1rem;">
        <i class="fas fa-tachometer-alt" style="color: var(--airbnb-red);"></i> Zoho Dashboards
    </h5>
    <div id="creDashboardsContainer">
        <!-- CRE dashboards will be loaded here -->
    </div>
</div>

<!-- CRE Leaderboard Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card analytics-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-trophy"></i> Top 5 CRE Performance Leaderboard</h5>
                <small class="text-white-50">Live performance metrics</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>CRE Name</th>
                                <th>üèÜ Won</th>
                                <th>üïì Pending</th>
                                <th>‚ùå Lost</th>
                                <th>Total Leads Assigned</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-table-body">
                            {% for cre_name, stats in analytics.top_5_leaderboard %}
                            <tr {% if cre_name == analytics.current_cre %}class="current-user-row"{% elif loop.index == 1 %}class="leaderboard-rank-1"{% endif %}>
                                <td>
                                    {% if loop.index == 1 %}
                                        <i class="fas fa-trophy trophy-icon"></i>{{ loop.index }}
                                    {% else %}
                                        {{ loop.index }}
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ cre_name }}</strong>
                                    {% if cre_name == analytics.current_cre %}<small>(You)</small>{% endif %}
                                </td>
                                <td><span class="badge bg-success">{{ stats.won }}</span></td>
                                <td><span class="badge bg-warning">{{ stats.pending_live }}</span></td>
                                <td><span class="badge bg-danger">{{ stats.lost }}</span></td>
                                <td><strong>{{ stats.total_leads_handled }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Separate script for dashboard loading -->
<script>
        // Load CRE dashboards
        function loadCreDashboards() {
            const container = document.getElementById('creDashboardsContainer');
            if (!container) {
                console.error('creDashboardsContainer not found!');
                return;
            }
            
            // Show loading state
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin fa-3x mb-3"></i><p>Loading dashboards...</p></div>';
            
            fetch('/api/dashboards')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.dashboards && data.dashboards.cre && data.dashboards.cre.length > 0) {
                        let html = '';
                        
                        data.dashboards.cre.forEach(dashboard => {
                            if (dashboard && dashboard.url && dashboard.name) {
                                html += `
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">${dashboard.name}</h6>
                                            <small class="text-muted">Added: ${new Date(dashboard.created_at).toLocaleDateString()}</small>
                                        </div>
                                        <div class="card-body p-0">
                                            <iframe src="${dashboard.url}" 
                                                    style="width: 100%; height: 600px; border: none;" 
                                                    frameborder="0"
                                                    onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-center text-danger py-4\'><i class=\'fas fa-exclamation-triangle fa-3x mb-3\'></i><p>Failed to load dashboard</p></div>';">
                                            </iframe>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        if (html === '') {
                            html = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No CRE dashboards configured yet.</p></div>';
                        }
                        
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No CRE dashboards configured yet.</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading CRE dashboards:', error);
                    container.innerHTML = '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Error loading dashboards. Please try again.</p></div>';
                });
        }

        // Load dashboards on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCreDashboards();
        });
        
        // Also try loading when window loads
        window.addEventListener('load', function() {
            loadCreDashboards();
        });
</script>
{% endblock %} 